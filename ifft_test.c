#include <F28x_Project.h>
#include "launchpad_drivers/launchpad_drivers.h"
#include "TI_FFT/fpu_cfft.h"
#include "TI_FFT/fpu_vector.h"
#include "TI_FFT/fpu_rfft.h"
#include "TI_FFT/fpu_fft_hamming.h"

#define FFT_STAGES (8)
#define FFT_SIZE (1 << FFT_STAGES)

// FFT Buffers
#pragma DATA_SECTION(xn, "ramgs0");
volatile int16 xn[2][FFT_SIZE*2];

#pragma DATA_SECTION(FFT_inBuff, "CFFTdata1");
float FFT_inBuff[FFT_SIZE+2U];

#pragma DATA_SECTION(FFT_outBuff, "CFFTdata2");
float FFT_outBuff[FFT_SIZE+2U];

// IFFT Buffers
#pragma DATA_SECTION(IFFT_inBuff, "RFFTdata1");
float IFFT_inBuff[FFT_SIZE];

#pragma DATA_SECTION(IFFT_outBuff, "ramgs2");
float IFFT_outBuff[FFT_SIZE];

#pragma DATA_SECTION(IFFT_CosSinBuff, "ramgs1");
float IFFT_CosSinBuff[FFT_SIZE];

#pragma DATA_SECTION(rfft_mag, "ramgs2");
float rfft_mag[FFT_SIZE];

// Window
const float fftWindow[FFT_SIZE >> 1] = HAMMING256;

// CFFT structure (N/2)
CFFT_F32_STRUCT cfft;
CFFT_F32_STRUCT_Handle hnd_cfft = &cfft;

// ICFFT structure (N)
CFFT_F32_STRUCT icfft;
CFFT_F32_STRUCT_Handle hnd_icfft = &icfft;

float test_input[256] = {
       0.000000000000F,   24.580134541265F,   17.119017293313F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293313F,    3.419865458735F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000000F,   24.580134541265F,   17.119017293313F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293313F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000000F,   24.580134541265F,   17.119017293313F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293313F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000000F,   24.580134541265F,   17.119017293313F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293313F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000000F,   24.580134541265F,   17.119017293313F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000000F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293313F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541265F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293314F,   31.119017293313F,   10.580134541264F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541266F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293314F,   31.119017293313F,   10.580134541263F,  -14.000000000000F,
     -10.580134541264F,   -3.119017293313F,  -17.119017293313F,  -24.580134541264F,
       0.000000000001F,   24.580134541265F,   17.119017293312F,    3.119017293313F,
      10.580134541265F,   14.000000000000F,  -10.580134541266F,  -31.119017293313F,
     -17.119017293312F,    3.419865458736F,   -0.000000000000F,   -3.419865458735F,
      17.119017293314F,   31.119017293313F,   10.580134541263F,  -14.000000000000F,
};

int main() {
    InitSysCtrl();
    // Initialize N/2 point CFFT
    CFFT_f32_setInputPtr(hnd_cfft, FFT_inBuff);
    CFFT_f32_setOutputPtr(hnd_cfft, FFT_outBuff);
    CFFT_f32_setTwiddlesPtr(hnd_cfft, CFFT_f32_twiddleFactors);
    CFFT_f32_setStages(hnd_cfft, FFT_STAGES-1);
    CFFT_f32_setFFTSize(hnd_cfft, FFT_SIZE >> 1);

    memcpy_fast(FFT_inBuff, test_input, FFT_SIZE*sizeof(float));

    // Apply the window
    RFFT_f32_win(&FFT_inBuff[0], (float *)&fftWindow, FFT_SIZE);

    // Calculate FFT
    CFFT_f32t(hnd_cfft);
    CFFT_f32_unpack(hnd_cfft);

    float *fft_output = CFFT_f32_getCurrOutputPtr(hnd_cfft);
    float *fft_input = CFFT_f32_getCurrInputPtr(hnd_cfft);
    CFFT_f32_setCurrInputPtr(hnd_cfft, fft_output);
    CFFT_f32_setCurrOutputPtr(hnd_cfft, fft_input);
    CFFT_f32_mag_TMU0(hnd_cfft);

    CFFT_f32_pack(hnd_cfft);
    fft_output = CFFT_f32_getCurrOutputPtr(hnd_cfft);
    fft_input = CFFT_f32_getCurrInputPtr(hnd_cfft);
    CFFT_f32_setCurrInputPtr(hnd_cfft, fft_output);
    CFFT_f32_setCurrOutputPtr(hnd_cfft, fft_input);

    //CFFT_f32_mag_TMU0(hnd_cfft);

    ICFFT_f32t(hnd_cfft);

    fft_output = CFFT_f32_getCurrOutputPtr(hnd_cfft);

    /* Using RFFT
    memcpy_fast(IFFT_inBuff, test_input, FFT_SIZE*sizeof(float));
    RFFT_F32_STRUCT fft_lr = {.InBuf = IFFT_inBuff,
                              .OutBuf = IFFT_outBuff,
                              .CosSinBuf = IFFT_CosSinBuff,
                              .MagBuf = rfft_mag,
                              .PhaseBuf = 0, // Not used
                              .FFTSize = FFT_SIZE,
                              .FFTStages = FFT_STAGES};

    RFFT_F32_STRUCT_Handle fft_lr_handle = &fft_lr;
    RFFT_f32_sincostable(fft_lr_handle);
    RFFT_f32(fft_lr_handle);
    RFFT_f32_mag_TMU0(fft_lr_handle);
    */

    while(1);
}
